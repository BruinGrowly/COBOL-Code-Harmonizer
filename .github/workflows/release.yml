name: Build and Release z/OS Package

on:
  release:
    types: [created]
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-zos-package:
    name: Build z/OS-Compatible Package
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel

    - name: Get version
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=0.1.0-dev" >> $GITHUB_OUTPUT
        fi

    - name: Build Python package
      run: |
        python -m build

    - name: Create z/OS deployment bundle
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        BUNDLE_NAME="cobol-harmonizer-zos-${VERSION}"

        # Create bundle directory
        mkdir -p ${BUNDLE_NAME}

        # Copy application files
        cp -r cobol_harmonizer ${BUNDLE_NAME}/
        cp -r jcl ${BUNDLE_NAME}/
        cp -r examples ${BUNDLE_NAME}/
        cp -r docs ${BUNDLE_NAME}/
        cp requirements.txt ${BUNDLE_NAME}/
        cp setup.py ${BUNDLE_NAME}/
        cp README.md ${BUNDLE_NAME}/
        cp LICENSE ${BUNDLE_NAME}/ 2>/dev/null || echo "No LICENSE file"

        # Create installation script for z/OS USS
        cat > ${BUNDLE_NAME}/install_zos.sh <<'EOF'
        #!/bin/bash
        # COBOL Code Harmonizer - z/OS USS Installation Script
        # Run this script on z/OS USS to install the tool

        set -e

        echo "=================================================="
        echo "  COBOL Code Harmonizer - z/OS USS Installation"
        echo "=================================================="

        # Check Python version
        if ! command -v python3 &> /dev/null; then
            echo "ERROR: Python 3.9+ required but not found"
            echo "Please install Python 3.9+ on z/OS USS first"
            exit 1
        fi

        PYTHON_VERSION=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
        echo "Found Python $PYTHON_VERSION"

        # Set z/OS environment variables
        export _BPXK_AUTOCVT=ON
        export _CEE_RUNOPTS="FILETAG(AUTOCVT,AUTOTAG) POSIX(ON)"
        export _TAG_REDIR_ERR=txt
        export _TAG_REDIR_IN=txt
        export _TAG_REDIR_OUT=txt

        # Install dependencies
        echo "Installing Python dependencies..."
        pip3 install --user -r requirements.txt

        # Install the package
        echo "Installing COBOL Code Harmonizer..."
        pip3 install --user -e .

        # Make JCL wrapper executable
        chmod +x jcl/harmonizer_wrapper.sh

        # Test installation
        echo ""
        echo "Testing installation..."
        python3 -m cobol_harmonizer.cli.commands --version

        echo ""
        echo "=================================================="
        echo "  Installation Complete!"
        echo "=================================================="
        echo ""
        echo "To analyze a COBOL program:"
        echo "  python3 -m cobol_harmonizer.cli.commands analyze MYPROG.cbl"
        echo ""
        echo "To submit via JCL:"
        echo "  1. Edit jcl/HARMONIZ.jcl with your dataset names"
        echo "  2. Submit: submit jcl/HARMONIZ.jcl"
        echo ""
        echo "Documentation: docs/IBM_MAINFRAME_INTEGRATION.md"
        echo "=================================================="
        EOF

        chmod +x ${BUNDLE_NAME}/install_zos.sh

        # Create quick start guide
        cat > ${BUNDLE_NAME}/QUICKSTART.md <<'EOF'
        # COBOL Code Harmonizer - z/OS Quick Start

        ## Installation (5 minutes)

        ```bash
        # 1. Upload this bundle to z/OS USS
        ftp your.zos.host
        > bin
        > put cobol-harmonizer-zos-*.tar.gz

        # 2. On z/OS USS, extract and install
        gunzip cobol-harmonizer-zos-*.tar.gz
        tar -xf cobol-harmonizer-zos-*.tar
        cd cobol-harmonizer-zos-*
        ./install_zos.sh

        # 3. Test it
        python3 -m cobol_harmonizer.cli.commands analyze examples/harmonious_example.cbl
        ```

        ## JCL Submission (2 minutes)

        ```jcl
        // Edit jcl/HARMONIZ.jcl:
        //   - Update HLQ (your high-level qualifier)
        //   - Update input/output dataset names
        //   - Submit

        // View results in output dataset
        ```

        ## Container Deployment (1 minute)

        ```bash
        # Build container
        docker build -f Dockerfile.zos -t cobol-harmonizer:zos .

        # Run analysis
        docker run --rm \
          -v /path/to/cobol:/input:ro \
          -v /path/to/output:/output \
          cobol-harmonizer:zos analyze /input/MYPROG.cbl --verbose
        ```

        ## Integration with IBM Tools

        - **IBM ADDI**: See `ibm/ADDI_PLUGIN.md`
        - **IBM Wazi**: See `ibm/WAZI_DEMO.md`
        - **SonarQube for z/OS**: Output SARIF format (`--format sarif`)

        ## Support

        - Full docs: `docs/IBM_MAINFRAME_INTEGRATION.md`
        - Issues: https://github.com/BruinGrowly/COBOL-Code-Harmonizer/issues
        EOF

        # Create tarball
        tar -czf ${BUNDLE_NAME}.tar.gz ${BUNDLE_NAME}/

        # Create zip (some IBM shops prefer zip)
        zip -r ${BUNDLE_NAME}.zip ${BUNDLE_NAME}/

        # Create checksums
        sha256sum ${BUNDLE_NAME}.tar.gz > ${BUNDLE_NAME}.tar.gz.sha256
        sha256sum ${BUNDLE_NAME}.zip > ${BUNDLE_NAME}.zip.sha256

        echo "Created z/OS bundles:"
        ls -lh ${BUNDLE_NAME}.*

    - name: Upload z/OS bundle (tar.gz)
      uses: actions/upload-artifact@v4
      with:
        name: zos-bundle-tar
        path: |
          cobol-harmonizer-zos-*.tar.gz
          cobol-harmonizer-zos-*.tar.gz.sha256

    - name: Upload z/OS bundle (zip)
      uses: actions/upload-artifact@v4
      with:
        name: zos-bundle-zip
        path: |
          cobol-harmonizer-zos-*.zip
          cobol-harmonizer-zos-*.zip.sha256

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          cobol-harmonizer-zos-*.tar.gz
          cobol-harmonizer-zos-*.tar.gz.sha256
          cobol-harmonizer-zos-*.zip
          cobol-harmonizer-zos-*.zip.sha256
          dist/*.whl
          dist/*.tar.gz
        body: |
          ## z/OS Deployment Package

          This release includes z/OS USS-ready deployment bundles:

          - **cobol-harmonizer-zos-*.tar.gz** - Complete z/OS USS bundle (recommended)
          - **cobol-harmonizer-zos-*.zip** - ZIP format for IBM shops
          - **.whl** - Python wheel for pip installation

          ### Quick Deploy to z/OS USS

          ```bash
          # 1. Upload bundle to z/OS USS
          ftp your.zos.host
          > bin
          > put cobol-harmonizer-zos-*.tar.gz

          # 2. Extract and install
          gunzip cobol-harmonizer-zos-*.tar.gz
          tar -xf cobol-harmonizer-zos-*.tar
          cd cobol-harmonizer-zos-*
          ./install_zos.sh

          # 3. Test
          python3 -m cobol_harmonizer.cli.commands analyze examples/harmonious_example.cbl
          ```

          ### IBM Integration

          - ✅ Works with IBM ADDI (see `ibm/ADDI_PLUGIN.md`)
          - ✅ Works with IBM Wazi (see `ibm/WAZI_DEMO.md`)
          - ✅ Outputs SARIF for SonarQube for z/OS
          - ✅ JCL templates included (`jcl/`)

          See `QUICKSTART.md` in the bundle for full deployment guide.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
